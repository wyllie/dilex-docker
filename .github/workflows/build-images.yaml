name: Build and Push Docker Images

on:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:
    inputs:
      build_latex:
        description: "Build/push the wyllie/latex image"
        required: false
        default: false
        type: boolean

# Central “tag knobs”
env:
  ALPINE_VERSION: "3.23.2"
  BASE_REV: "1"

  # For tagging clarity (build args are set in Dockerfiles too)
  HUGO_VERSION: "0.154.2"
  SASS_VERSION: "1.97.1"

concurrency:
  group: docker-images-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ci-base:
    name: Build ci-base
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and (optionally) push
        uses: docker/build-push-action@v6
        with:
          context: ./images/ci-base
          file: ./images/ci-base/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            wyllie/ci-base:alpine${{ env.ALPINE_VERSION }}-${{ env.BASE_REV }}
            wyllie/ci-base:main

  build-stage1:
    name: Build stage1 ${{ matrix.image }}
    runs-on: ubuntu-latest
    needs: build-ci-base
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: hugo
            context: ./images/hugo
            dockerfile: ./images/hugo/Dockerfile

          - image: cdk
            context: ./images/cdk
            dockerfile: ./images/cdk/Dockerfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail

          case "${{ matrix.image }}" in
            hugo)
              TAGS="wyllie/hugo:hugo${HUGO_VERSION}-sass${SASS_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}\nwyllie/hugo:main"
              ;;
            cdk)
              TAGS="wyllie/cdk:awscli2-alpine${ALPINE_VERSION}-${BASE_REV}\nwyllie/cdk:main"
              ;;
            *)
              echo "Unknown matrix.image: ${{ matrix.image }}" >&2
              exit 2
              ;;
          esac

          {
            echo 'tags<<EOF'
            echo -e "$TAGS"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build and (optionally) push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.tags.outputs.tags }}

  build-stage2:
    name: Build stage2 hugo-aws
    runs-on: ubuntu-latest
    needs: build-stage1
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'tags<<EOF'
            echo "wyllie/hugo-aws:hugo${HUGO_VERSION}-sass${SASS_VERSION}-awscli2-alpine${ALPINE_VERSION}-${BASE_REV}"
            echo "wyllie/hugo-aws:main"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build and (optionally) push
        uses: docker/build-push-action@v6
        with:
          context: ./images/hugo-aws
          file: ./images/hugo-aws/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.tags.outputs.tags }}

  build-latex:
    name: Build latex (manual)
    runs-on: ubuntu-latest
    needs: build-ci-base
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.build_latex }}
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'tags<<EOF'
            echo "wyllie/latex:alpine${ALPINE_VERSION}-texlive-${BASE_REV}"
            echo "wyllie/latex:main"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./images/latex
          file: ./images/latex/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
