name: Build and Push Docker Images

on:
  release:
    types: [published]

# Central “tag knobs”
env:
  ALPINE_VERSION: "3.23.2"
  BASE_REV: "1"
  AWSCLI_VERSION: "2.32.7"

  # Registry namespaces
  DOCKERHUB_NS: "wyllie"
  GHCR_NS: "ghcr.io/dilexnetworks"

  # For tagging clarity (build args are set in Dockerfiles too)
  HUGO_VERSION: "0.154.2"
  SASS_VERSION: "1.97.1"

concurrency:
  group: docker-images-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ci-base:
    name: Build ci-base
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./images/ci-base
          file: ./images/ci-base/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ env.DOCKERHUB_NS }}/ci-base:alpine${{ env.ALPINE_VERSION }}-${{ env.BASE_REV }}
            ${{ env.DOCKERHUB_NS }}/ci-base:main
            ${{ env.GHCR_NS }}/ci-base:alpine${{ env.ALPINE_VERSION }}-${{ env.BASE_REV }}
            ${{ env.GHCR_NS }}/ci-base:main

  build-stage1:
    name: Build stage1 ${{ matrix.image }}
    runs-on: ubuntu-latest
    needs: build-ci-base
    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - image: hugo
            context: ./images/hugo
            dockerfile: ./images/hugo/Dockerfile

          - image: aws-cli
            context: ./images/aws-cli
            dockerfile: ./images/aws-cli/Dockerfile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail

          case "${{ matrix.image }}" in
            hugo)
              TAGS="${DOCKERHUB_NS}/hugo:hugo${HUGO_VERSION}-sass${SASS_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}\n${DOCKERHUB_NS}/hugo:main\n${DOCKERHUB_NS}/hugo:latest\n${GHCR_NS}/hugo:hugo${HUGO_VERSION}-sass${SASS_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}\n${GHCR_NS}/hugo:main\n${GHCR_NS}/hugo:latest"
              ;;
            aws-cli)
              TAGS="${DOCKERHUB_NS}/aws-cli:awscli${AWSCLI_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}\n${DOCKERHUB_NS}/aws-cli:main\n${DOCKERHUB_NS}/aws-cli:latest\n${GHCR_NS}/aws-cli:awscli${AWSCLI_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}\n${GHCR_NS}/aws-cli:main\n${GHCR_NS}/aws-cli:latest"
              ;;
            *)
              echo "Unknown matrix.image: ${{ matrix.image }}" >&2
              exit 2
              ;;
          esac

          {
            echo 'tags<<EOF'
            echo -e "$TAGS"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  build-stage2:
    name: Build stage2 cdk
    runs-on: ubuntu-latest
    needs: build-stage1
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'tags<<EOF'
            echo "${DOCKERHUB_NS}/cdk:awscli${AWSCLI_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}"
            echo "${DOCKERHUB_NS}/cdk:main"
            echo "${DOCKERHUB_NS}/cdk:latest"
            echo "${GHCR_NS}/cdk:awscli${AWSCLI_VERSION}-alpine${ALPINE_VERSION}-${BASE_REV}"
            echo "${GHCR_NS}/cdk:main"
            echo "${GHCR_NS}/cdk:latest"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./images/cdk
          file: ./images/cdk/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}

  build-latex:
    name: Build latex (disabled)
    # Disabled for now: LaTeX image build is still experimental and currently fails.
    # Re-enable when ready to debug/finish the Dockerfile.
    if: false
    runs-on: ubuntu-latest
    needs: build-ci-base
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          set -euo pipefail
          {
            echo 'tags<<EOF'
            echo "${DOCKERHUB_NS}/latex:alpine${ALPINE_VERSION}-texlive-${BASE_REV}"
            echo "${DOCKERHUB_NS}/latex:main"
            echo "${GHCR_NS}/latex:alpine${ALPINE_VERSION}-texlive-${BASE_REV}"
            echo "${GHCR_NS}/latex:main"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: ./images/latex
          file: ./images/latex/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.tags.outputs.tags }}
